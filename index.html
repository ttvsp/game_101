<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F8F9FA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¸Ð³Ñ€Ñ‹ Ð² ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡Ð½ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ 101">
    <meta name="author" content="Denis">
    <title>Ð˜Ð³Ñ€Ð° 101</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽ®</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ===== DESIGN SYSTEM 2026 ===== */
        :root {
            /* Base colors - Light theme */
            --color-bg-primary: #F8F9FA;
            --color-bg-secondary: #FFFFFF;
            --color-bg-tertiary: #F1F3F5;
            --color-bg-elevated: #FFFFFF;
            
            /* Text colors */
            --color-text-primary: #1A1A1A;
            --color-text-secondary: #6B7280;
            --color-text-tertiary: #9CA3AF;
            --color-text-disabled: #D1D5DB;
            
            /* Accent colors - Vibrant and modern */
            --color-accent-primary: #3B82F6;
            --color-accent-success: #10B981;
            --color-accent-warning: #F59E0B;
            --color-accent-error: #EF4444;
            --color-accent-purple: #8B5CF6;
            
            /* Chart colors - Bright and distinguishable */
            --color-chart-1: #3B82F6;
            --color-chart-2: #10B981;
            --color-chart-3: #F59E0B;
            --color-chart-4: #EF4444;
            --color-chart-5: #8B5CF6;
            --color-chart-6: #EC4899;
            --color-chart-7: #14B8A6;
            --color-chart-8: #F97316;
            
            /* Borders */
            --color-border-subtle: #E5E7EB;
            --color-border-default: #D1D5DB;
            --color-border-strong: #9CA3AF;
            
            /* Shadows - Softer for light theme */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.12);
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-base: 0;
            --z-dropdown: 1000;
            --z-sticky: 1100;
            --z-fixed: 1200;
            --z-modal-backdrop: 1300;
            --z-modal: 1400;
            --z-popover: 1500;
            --z-tooltip: 1600;
        }
        
        /* ===== RESET & BASE ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-size-adjust: 100%;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            line-height: 1.5;
            color: var(--color-text-primary);
            background-color: var(--color-bg-secondary);
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-bold);
            line-height: 1.2;
            color: var(--color-text-primary);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-2xl); }
        h3 { font-size: var(--font-size-xl); }
        
        /* ===== LAYOUT ===== */
        .app {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg-secondary);
        }
        
        /* Platform-specific adjustments */
        body.platform-mobile .app {
            width: 100%;
            max-width: 100%;
            /* Add safe area padding for mobile (except top - handled by sticky header) */
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        body.platform-desktop .app {
            width: 100%;
            max-width: 100%;
        }
        
        /* For smaller screens, maintain max-width */
        @media (min-width: 800px) {
            body.platform-desktop .app {
                max-width: 800px;
            }
        }
        
        .screen {
            display: none;
            opacity: 0;
            animation: fadeIn var(--transition-base) forwards;
            flex-direction: column;
            width: 100%;
        }
        
        .screen.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            background-color: #FFFFFF;
            border-bottom: 1px solid var(--color-border-subtle);
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: var(--z-sticky);
            width: 100%;
        }
        
        /* Fill area above sticky header on mobile to prevent content showing through */
        body.platform-mobile .header::before {
            content: '';
            position: absolute;
            top: calc(-1 * max(env(safe-area-inset-top, 0px), 56px));
            left: 0;
            right: 0;
            height: max(env(safe-area-inset-top, 0px), 56px);
            background-color: #FFFFFF;
            z-index: -1;
        }
        
        /* Mobile header sticky positioning with safe area */
        body.platform-mobile .header {
            top: max(env(safe-area-inset-top, 0px), 56px);
            margin-top: max(env(safe-area-inset-top, 0px), 56px);
        }
        
        .header-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }
        
        .btn-back {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            border: none;
            color: var(--color-text-primary);
            font-size: var(--font-size-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-back:hover {
            background: var(--color-bg-elevated);
            transform: scale(1.05);
        }
        
        .btn-back:active {
            transform: scale(0.95);
        }
        
        /* ===== CONTENT ===== */
        .content {
            padding: var(--space-4);
        }
        
        @media (min-width: 768px) {
            .content {
                padding: var(--space-6);
            }
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-xl);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .btn-primary {
            background: var(--color-accent-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-success {
            background: var(--color-accent-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--color-accent-error);
            color: white;
        }
        
        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-default);
        }
        
        .btn-secondary:hover {
            background: var(--color-bg-tertiary);
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: var(--radius-full);
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== INPUTS ===== */
        .input-group {
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: block;
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            transition: all var(--transition-fast);
            min-height: 44px;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            background: var(--color-bg-tertiary);
        }
        
        .input::placeholder {
            color: var(--color-text-tertiary);
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .card:hover:not(.history-card) {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border-default);
            transform: translateY(-2px);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }
        
        .card-content {
            color: var(--color-text-secondary);
        }
        
        /* ===== WELCOME SCREEN ===== */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--space-6);
            text-align: center;
        }
        
        .welcome-logo {
            width: 140px;
            height: 140px;
            margin-bottom: var(--space-3);
            opacity: 0;
            animation: logoFadeIn 0.8s ease-out 0.2s forwards;
        }
        
        @keyframes logoFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        body.platform-desktop .welcome-logo {
            width: 180px;
            height: 180px;
        }
        
        .welcome-title {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-2);
            color: var(--color-text-primary);
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .welcome-subtitle {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
            font-size: var(--font-size-lg);
        }
        
        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            width: 100%;
            max-width: 320px;
        }
        
        .welcome-button {
            width: 100%;
        }
        
        /* ===== PLAYER SETUP ===== */
        .player-list {
            margin-bottom: var(--space-6);
        }
        
        .player-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .player-item .input {
            flex: 1;
        }
        
        .player-color {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 2px solid var(--color-border-default);
            flex-shrink: 0;
        }
        
        .btn-remove {
            background: transparent;
            border: none;
            color: var(--color-accent-error);
            font-size: 1.75rem;
            cursor: pointer;
            padding: var(--space-2);
            line-height: 1;
            transition: all var(--transition-fast);
            width: 36px;
            height: 36px;
        }
        
        .btn-remove:hover {
            transform: scale(1.2);
        }
        
        .add-player-container {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-6);
        }
        
        /* ===== GAME SCREEN ===== */
        .game-layout {
            display: grid;
            gap: var(--space-4);
        }
        
        .scoreboard {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-4);
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .scoreboard-title {
            margin-bottom: var(--space-3);
            font-size: var(--font-size-lg);
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-lg);
            border-left: 4px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .score-item.leader {
            border-left-color: var(--color-accent-success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .score-player {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .score-player-color {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }
        
        .score-player-name {
            font-weight: var(--font-weight-medium);
        }
        
        .score-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }
        
        /* ===== ROUND INPUT ===== */
        .round-inputs {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-4);
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .round-title {
            margin-bottom: var(--space-3);
            font-size: var(--font-size-lg);
        }
        
        .round-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        
        .round-label {
            min-width: 100px;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        .round-item .input {
            max-width: 120px;
        }
        
        /* ===== CHART ===== */
        .chart-container {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-4);
            height: 400px;
            position: relative;
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        @media (max-width: 640px) {
            .chart-container {
                height: 320px;
                padding: var(--space-3);
            }
        }
        
        /* ===== HISTORY ===== */
        .history-list {
            display: grid;
            gap: var(--space-4);
        }
        
        .history-card {
            cursor: default;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }
        
        .history-date {
            font-size: var(--font-size-sm);
            color: var(--color-text-tertiary);
        }
        
        .history-players {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .history-player {
            padding: var(--space-1) var(--space-3);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }
        
        .history-loser {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-accent-error);
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-2);
        }
        
        .empty-text {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-6);
        }
        
        /* ===== MODAL ===== */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: var(--z-modal-backdrop);
            backdrop-filter: blur(4px);
        }
        
        .modal-backdrop.active {
            display: block;
            animation: fadeIn var(--transition-fast);
        }
        
        .modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            padding: var(--space-6);
            z-index: var(--z-modal);
            transform: translateY(100%);
            transition: transform var(--transition-base);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal.active {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            padding: var(--space-2);
            line-height: 1;
        }
        
        .modal-content {
            margin-bottom: var(--space-6);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-3);
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* ===== NOTIFICATION SYSTEM (Professional 2026) ===== */
        .notification {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 100px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 10004;
            width: 100%;
            max-width: 380px;
            padding: 0 16px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translate(-50%, -20px) scale(0.95);
        }

        body.platform-desktop .notification {
            top: 12px;
            width: 360px;
        }

        .notification.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, 0) scale(1);
        }

        .notification-content {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 12px;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .notification-icon.icon-success::before {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' rx='8' fill='%2360D236'/%3E%3Cpath d='M26.1249 15.1748C26.3972 14.7293 26.2567 14.1474 25.8112 13.8751C25.3656 13.6028 24.7837 13.7433 24.5114 14.1888L18.6824 23.7272L15.3933 19.9683C15.0495 19.5754 14.4522 19.5355 14.0592 19.8794C13.6663 20.2232 13.6264 20.8205 13.9703 21.2135L18.1067 25.9408C18.3048 26.1672 18.5988 26.2858 18.8986 26.2602C19.1983 26.2346 19.468 26.0679 19.6249 25.8112L26.1249 15.1748Z' fill='white'/%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M33 20C33 27.1797 27.1797 33 20 33C12.8203 33 7 27.1797 7 20C7 12.8203 12.8203 7 20 7C27.1797 7 33 12.8203 33 20ZM30.8333 20C30.8333 25.9831 25.9831 30.8333 20 30.8333C14.0169 30.8333 9.16667 25.9831 9.16667 20C9.16667 14.0169 14.0169 9.16667 20 9.16667C25.9831 9.16667 30.8333 14.0169 30.8333 20Z' fill='white'/%3E%3C/svg%3E");
        }

        .notification-icon.icon-error::before {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' rx='8' fill='%23FF3A30'/%3E%3Cpath d='M28.9929 13.0214C29.5491 12.4652 29.5491 11.5634 28.9929 11.0071C28.4366 10.4509 27.5348 10.4509 26.9786 11.0071L20 17.9857L13.0214 11.0071C12.4652 10.4509 11.5634 10.4509 11.0071 11.0071C10.4509 11.5634 10.4509 12.4652 11.0071 13.0214L17.9857 20L11.0071 26.9786C10.4509 27.5348 10.4509 28.4366 11.0071 28.9929C11.5634 29.5491 12.4652 29.5491 13.0214 28.9929L20 22.0143L26.9786 28.9929C27.5348 29.5491 28.4366 29.5491 28.9929 28.9929C29.5491 28.4366 29.5491 27.5348 28.9929 26.9786L22.0143 20L28.9929 13.0214Z' fill='white'/%3E%3C/svg%3E");
        }

        .notification-icon.icon-warning::before {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' rx='8' fill='%23FF9500'/%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M18.9279 10.2305C18.1455 10.583 17.5462 11.6331 16.3477 13.7333L10.7171 23.6C9.51851 25.7002 8.91923 26.7504 9.00875 27.6121C9.08684 28.3637 9.47649 29.0465 10.0808 29.4907C10.7737 30 11.9723 30 14.3694 30H25.6306C28.0277 30 29.2263 30 29.9192 29.4907C30.5235 29.0465 30.9132 28.3637 30.9912 27.6121C31.0808 26.7504 30.4815 25.7002 29.2829 23.6L23.6523 13.7333C22.4538 11.6331 21.8545 10.583 21.0721 10.2305C20.3897 9.92315 19.6103 9.92315 18.9279 10.2305ZM20.9498 16.7554L20.8497 22.489C20.8416 22.9577 20.4637 23.3333 20.0003 23.3333C19.537 23.3333 19.1591 22.9577 19.1509 22.489L19.0509 16.7554C19.0416 16.2183 19.4694 15.7778 20.0003 15.7778C20.5313 15.7778 20.9591 16.2183 20.9498 16.7554ZM21.0983 25.5556C21.0983 26.1692 20.6066 26.6667 20 26.6667C19.3934 26.6667 18.9017 26.1692 18.9017 25.5556C18.9017 24.9419 19.3934 24.4444 20 24.4444C20.6066 24.4444 21.0983 24.9419 21.0983 25.5556Z' fill='white'/%3E%3C/svg%3E");
        }

        .notification-text {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            line-height: 1.3;
            margin-bottom: 2px;
        }

        .notification-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .notification-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-close::before {
            content: '';
            display: block;
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M0.334735 0.334735C0.781049 -0.111578 1.50467 -0.111578 1.95098 0.334735L8 6.38376L14.049 0.334735C14.4953 -0.111578 15.219 -0.111578 15.6653 0.334735C16.1116 0.781049 16.1116 1.50467 15.6653 1.95098L9.61624 8L15.6653 14.049C16.1116 14.4953 16.1116 15.219 15.6653 15.6653C15.219 16.1116 14.4953 16.1116 14.049 15.6653L8 9.61624L1.95098 15.6653C1.50467 16.1116 0.781049 16.1116 0.334735 15.6653C-0.111578 15.219 -0.111578 14.4953 0.334735 14.049L6.38376 8L0.334735 1.95098C-0.111578 1.50467 -0.111578 0.781049 0.334735 0.334735Z' fill='black'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* ===== UTILITIES ===== */
        .text-center { text-align: center; }
        .text-success { color: var(--color-accent-success); }
        .text-error { color: var(--color-accent-error); }
        .text-warning { color: var(--color-accent-warning); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .hidden { display: none !important; }
        
        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes scoreUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: var(--color-bg-elevated); }
            100% { transform: scale(1); }
        }
        
        .score-updated {
            animation: scoreUpdate 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        /* ===== SCROLLBAR ===== */
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color-bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--color-bg-elevated);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-border-strong);
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--color-bg-elevated) var(--color-bg-primary);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-container {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app"></div>

    <script>
        'use strict';

        // ===== CONSTANTS =====
        const STORAGE_VERSION = '1.0';
        const STORAGE_KEY = 'game101_data';
        const CHART_COLORS = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
            '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
        ];

        // ===== UTILITIES =====
        const Utils = {
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            formatDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                // Less than 1 hour ago
                if (diffMins < 60) {
                    if (diffMins < 1) return 'Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾';
                    return `${diffMins} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;
                }
                
                // Less than 24 hours ago
                if (diffMins < 1440) {
                    const hours = Math.floor(diffMins / 60);
                    return `${hours} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;
                }
                
                // More than 24 hours - show full date
                return new Intl.DateTimeFormat('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            },
            
            formatDuration(ms) {
                const minutes = Math.floor(ms / 60000);
                if (minutes < 60) return `${minutes} Ð¼Ð¸Ð½`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours} Ñ‡ ${mins} Ð¼Ð¸Ð½`;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ===== STORAGE MANAGER =====
        class StorageManager {
            constructor() {
                this.init();
            }
            
            init() {
                try {
                    const data = this.load();
                    if (!data || data.version !== STORAGE_VERSION) {
                        this.initializeStorage();
                    }
                } catch (error) {
                    console.error('Storage init error:', error);
                    this.initializeStorage();
                }
            }
            
            initializeStorage() {
                const defaultData = {
                    version: STORAGE_VERSION,
                    currentGame: null,
                    completedGames: [],
                    players: [], // List of known player names
                    settings: {
                        hapticEnabled: true,
                        soundEnabled: false
                    }
                };
                this.save(defaultData);
            }
            
            load() {
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Storage load error:', error);
                    return null;
                }
            }
            
            save(data) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage save error:', error);
                    return false;
                }
            }
            
            getCurrentGame() {
                const data = this.load();
                return data?.currentGame;
            }
            
            saveCurrentGame(game) {
                const data = this.load();
                if (data) {
                    data.currentGame = game;
                    return this.save(data);
                }
                return false;
            }
            
            clearCurrentGame() {
                const data = this.load();
                if (data) {
                    data.currentGame = null;
                    return this.save(data);
                }
                return false;
            }
            
            getCompletedGames() {
                const data = this.load();
                return data?.completedGames || [];
            }
            
            saveCompletedGame(game) {
                const data = this.load();
                if (data) {
                    data.completedGames.unshift(game);
                    return this.save(data);
                }
                return false;
            }
            
            clearAllGames() {
                const data = this.load();
                if (data) {
                    data.completedGames = [];
                    data.currentGame = null;
                    return this.save(data);
                }
                return false;
            }
            
            // Player management
            getPlayers() {
                const data = this.load();
                return data?.players || [];
            }
            
            addPlayer(name) {
                const data = this.load();
                if (data) {
                    const trimmedName = name.trim();
                    if (!trimmedName) return false;
                    
                    // Check if player already exists
                    if (!data.players) data.players = [];
                    if (!data.players.includes(trimmedName)) {
                        data.players.push(trimmedName);
                        // Keep only last 20 unique players
                        if (data.players.length > 20) {
                            data.players = data.players.slice(-20);
                        }
                        return this.save(data);
                    }
                }
                return false;
            }
            
            removePlayer(name) {
                const data = this.load();
                if (data && data.players) {
                    const index = data.players.indexOf(name);
                    if (index > -1) {
                        data.players.splice(index, 1);
                        return this.save(data);
                    }
                }
                return false;
            }
            
            clearAllPlayers() {
                const data = this.load();
                if (data) {
                    data.players = [];
                    return this.save(data);
                }
                return false;
            }
        }

        // ===== GAME ENGINE =====
        class GameEngine {
            constructor() {
                this.id = null;
                this.createdAt = null;
                this.updatedAt = null;
                this.players = [];
                this.rounds = [];
                this.status = 'setup';
            }
            
            createGame(playerNames) {
                if (playerNames.length < 2) {
                    throw new Error('ÐÑƒÐ¶Ð½Ð¾ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 2 Ð¸Ð³Ñ€Ð¾ÐºÐ°');
                }
                
                // Check for duplicates
                const uniqueNames = new Set(playerNames);
                if (uniqueNames.size !== playerNames.length) {
                    throw new Error('Ð˜Ð¼ÐµÐ½Ð° Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸');
                }
                
                this.id = Utils.generateId();
                this.createdAt = Date.now();
                this.updatedAt = Date.now();
                this.status = 'in_progress';
                
                this.players = playerNames.map((name, index) => ({
                    id: Utils.generateId(),
                    name: name.trim(),
                    color: CHART_COLORS[index % CHART_COLORS.length],
                    score: 0,
                    scoreHistory: [0]
                }));
                
                return this;
            }
            
            submitRound(points) {
                if (this.status !== 'in_progress') {
                    throw new Error('Ð˜Ð³Ñ€Ð° Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°');
                }
                
                // Validate points
                for (const player of this.players) {
                    if (!(player.id in points)) {
                        throw new Error(`ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð¾Ñ‡ÐºÐ¸ Ð´Ð»Ñ ${player.name}`);
                    }
                    if (typeof points[player.id] !== 'number' || isNaN(points[player.id])) {
                        throw new Error(`ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ðµ Ð¾Ñ‡ÐºÐ¸ Ð´Ð»Ñ ${player.name}`);
                    }
                }
                
                const round = {
                    roundNumber: this.rounds.length + 1,
                    timestamp: Date.now(),
                    points: { ...points }
                };
                
                // Calculate new scores
                const results = [];
                
                for (const player of this.players) {
                    const pointsEarned = points[player.id];
                    let newScore = player.score + pointsEarned;
                    
                    // Apply game rules
                    if (newScore === 50) {
                        newScore = 25; // Cutoff at 50
                    } else if (newScore === 101) {
                        // Reset to 0 when reaching exactly 101
                        newScore = 0;
                    } else if (newScore > 101) {
                        // Loser - exceeded 101
                        results.push({ playerId: player.id, status: 'loser', score: newScore });
                    }
                    
                    player.score = newScore;
                    player.scoreHistory.push(newScore);
                }
                
                this.rounds.push(round);
                this.updatedAt = Date.now();
                
                // Check for game end (only when someone loses)
                const loser = results.find(r => r.status === 'loser');
                
                if (loser) {
                    this.status = 'finished';
                    return {
                        gameOver: true,
                        loser: this.players.find(p => p.id === loser.playerId)
                    };
                }
                
                return { gameOver: false };
            }
            
            toJSON() {
                return {
                    id: this.id,
                    createdAt: this.createdAt,
                    updatedAt: this.updatedAt,
                    players: this.players,
                    rounds: this.rounds,
                    status: this.status
                };
            }
            
            fromJSON(data) {
                Object.assign(this, data);
                return this;
            }
        }

        // ===== TELEGRAM API =====
        class TelegramAPI {
            constructor() {
                this.app = window.Telegram?.WebApp;
                this.backButtonCallback = null;
                this.init();
            }
            
            init() {
                if (!this.app) return;
                
                try {
                    // Basic initialization
                    this.app.ready();
                    this.app.expand();
                    this.app.disableVerticalSwipes();
                    this.app.setHeaderColor('#F8F9FA');
                    this.app.setBackgroundColor('#F8F9FA');
                    this.app.enableClosingConfirmation();
                    
                    // Hide BackButton initially
                    this.app.BackButton.hide();
                    
                    // Add platform class to body
                    const isMobile = ['android', 'ios'].includes(this.app.platform);
                    document.body.classList.add(isMobile ? 'platform-mobile' : 'platform-desktop');
                    
                    // Show SettingsButton on desktop for reload capability
                    if (!isMobile && this.app.SettingsButton && this.app.isVersionAtLeast('6.10')) {
                        this.app.SettingsButton.show();
                        this.app.SettingsButton.onClick(() => {
                            this.showSettingsMenu();
                        });
                    }
                    
                    // Request fullscreen on mobile only (requires Telegram WebApp API 8.0+)
                    if (['android', 'ios'].includes(this.app.platform) && this.app.isVersionAtLeast('8.0')) {
                        setTimeout(() => {
                            if (typeof this.app.requestFullscreen === 'function') {
                                const result = this.app.requestFullscreen();
                                if (result && typeof result.then === 'function') {
                                    result
                                        .then(() => {
                                            console.log('Fullscreen mode enabled');
                                        })
                                        .catch((error) => {
                                            console.log('Fullscreen not available, using expand:', error);
                                            this.app.expand();
                                        });
                                }
                            } else {
                                console.log('requestFullscreen not available');
                            }
                        }, 300);
                    }
                    
                    // Desktop: keep in medium mode (no fullscreen)
                    // This provides better UX on larger screens
                } catch (error) {
                    console.error('Telegram API init error:', error);
                }
            }
            
            // BackButton management
            showBackButton(callback) {
                if (!this.app?.BackButton) return;
                
                // Remove old callback if exists
                if (this.backButtonCallback) {
                    this.app.BackButton.offClick(this.backButtonCallback);
                }
                
                // Set new callback
                this.backButtonCallback = callback;
                this.app.BackButton.onClick(this.backButtonCallback);
                this.app.BackButton.show();
            }
            
            hideBackButton() {
                if (!this.app?.BackButton) return;
                
                // Remove callback
                if (this.backButtonCallback) {
                    this.app.BackButton.offClick(this.backButtonCallback);
                    this.backButtonCallback = null;
                }
                
                this.app.BackButton.hide();
            }
            
            // Settings menu for desktop
            showSettingsMenu() {
                if (!this.app) {
                    window.location.reload();
                    return;
                }
                
                this.app.showPopup({
                    title: 'ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸',
                    message: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ',
                    buttons: [
                        { id: 'reload', type: 'default', text: 'ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ' },
                        { id: 'cancel', type: 'cancel' }
                    ]
                }, (buttonId) => {
                    if (buttonId === 'reload') {
                        window.location.reload();
                    }
                });
            }
            
            haptic(type = 'light') {
                if (!this.app?.HapticFeedback) return;
                try {
                    if (type === 'success' || type === 'error' || type === 'warning') {
                        this.app.HapticFeedback.notificationOccurred(type);
                    } else {
                        this.app.HapticFeedback.impactOccurred(type);
                    }
                } catch (error) {
                    console.error('Haptic error:', error);
                }
            }
            
            showAlert(message) {
                if (this.app?.showAlert) {
                    this.app.showAlert(message);
                } else {
                    alert(message);
                }
            }
            
            showConfirm(message, callback) {
                if (this.app?.showConfirm) {
                    this.app.showConfirm(message, callback);
                } else {
                    const result = confirm(message);
                    callback(result);
                }
            }
        }

        // ===== ROUTER =====
        class Router {
            constructor(app) {
                this.app = app;
                this.currentScreen = null;
                this.isNavigating = false;
            }
            
            navigate(screenName, data = {}) {
                if (this.isNavigating) return;
                this.isNavigating = true;
                
                const oldScreen = this.currentScreen;
                const newScreen = this.app.screens[screenName];
                
                if (!newScreen) {
                    this.isNavigating = false;
                    return;
                }
                
                // Fade out old screen
                if (oldScreen) {
                    oldScreen.element.style.animation = 'fadeOut var(--transition-base) forwards';
                    setTimeout(() => {
                        oldScreen.element.style.display = 'none';
                        oldScreen.element.classList.remove('active');
                        oldScreen.element.style.animation = '';
                        
                        // Show new screen
                        this.showNewScreen(newScreen, data);
                    }, 200);
                } else {
                    // No old screen, show new screen immediately
                    this.showNewScreen(newScreen, data);
                }
                
                window.scrollTo(0, 0);
            }
            
            showNewScreen(screen, data) {
                this.currentScreen = screen;
                screen.render(data);
                screen.element.style.display = 'block';
                screen.element.style.opacity = '0';
                
                // Force reflow
                screen.element.offsetHeight;
                
                setTimeout(() => {
                    screen.element.classList.add('active');
                    screen.element.style.opacity = '1';
                    this.isNavigating = false;
                }, 50);
            }
        }

        // ===== NOTIFICATION MANAGER (Professional 2026) =====
        class ToastManager {
            constructor() {
                this.element = null;
                this.isVisible = false;
                this.timeoutId = null;
                this.init();
            }
            
            init() {
                // Create notification element
                this.element = document.createElement('div');
                this.element.className = 'notification';
                this.element.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon"></div>
                        <div class="notification-text">
                            <div class="notification-title"></div>
                            <div class="notification-desc"></div>
                        </div>
                        <div class="notification-close"></div>
                    </div>
                `;
                document.body.appendChild(this.element);
                
                // Add close handler
                const closeBtn = this.element.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => this.hide());
            }
            
            show(title, description = '', type = 'error', duration = 3000) {
                // Clear existing timeout
                if (this.timeoutId) {
                    clearTimeout(this.timeoutId);
                    this.timeoutId = null;
                }
                
                // Update content
                const iconEl = this.element.querySelector('.notification-icon');
                const titleEl = this.element.querySelector('.notification-title');
                const descEl = this.element.querySelector('.notification-desc');
                
                iconEl.className = `notification-icon icon-${type}`;
                titleEl.textContent = title;
                descEl.textContent = description;
                
                // Show notification
                this.isVisible = true;
                requestAnimationFrame(() => {
                    this.element.classList.add('show');
                });
                
                // Auto-hide
                this.timeoutId = setTimeout(() => {
                    this.hide();
                }, duration);
            }
            
            hide() {
                if (this.timeoutId) {
                    clearTimeout(this.timeoutId);
                    this.timeoutId = null;
                }
                
                this.element.classList.remove('show');
                this.isVisible = false;
            }
            
            // Backward compatibility aliases
            showSuccess(title, description) {
                this.show(title, description, 'success');
            }
            
            showError(title, description) {
                this.show(title, description, 'error');
            }
            
            showWarning(title, description) {
                this.show(title, description, 'warning');
            }
        }
        
        // ===== APP =====
        class App {
            constructor() {
                this.storage = new StorageManager();
                this.telegram = new TelegramAPI();
                this.game = new GameEngine();
                this.router = new Router(this);
                this.toast = new ToastManager();
                this.chart = null;
                this.screens = {};
                
                this.init();
            }
            
            init() {
                this.initScreens();
                this.checkForSavedGame();
            }
            
            initScreens() {
                // Create all screens
                this.screens.welcome = new WelcomeScreen(this);
                this.screens.setup = new SetupScreen(this);
                this.screens.game = new GameScreen(this);
                this.screens.finish = new FinishScreen(this);
                this.screens.history = new HistoryScreen(this);
                
                // Render to app container
                const appElement = document.getElementById('app');
                Object.values(this.screens).forEach(screen => {
                    appElement.appendChild(screen.element);
                });
            }
            
            checkForSavedGame() {
                const savedGame = this.storage.getCurrentGame();
                if (savedGame) {
                    // Has saved game
                    this.router.navigate('welcome', { hasSavedGame: true });
                } else {
                    // No saved game
                    this.router.navigate('welcome', { hasSavedGame: false });
                }
            }
            
            startNewGame(playerNames) {
                try {
                    this.game = new GameEngine();
                    this.game.createGame(playerNames);
                    this.saveGame();
                    this.telegram.haptic('light');
                    this.router.navigate('game');
                } catch (error) {
                    this.toast.showError('ÐžÑˆÐ¸Ð±ÐºÐ°', error.message);
                    this.telegram.haptic('light');
                }
            }
            
            continueGame() {
                const savedGame = this.storage.getCurrentGame();
                if (savedGame) {
                    this.game = new GameEngine().fromJSON(savedGame);
                    this.router.navigate('game');
                }
            }
            
            submitRound(points) {
                try {
                    const result = this.game.submitRound(points);
                    this.saveGame();
                    this.telegram.haptic('light');
                    
                    if (result.gameOver) {
                        this.finishGame(result);
                    }
                    
                    return result;
                } catch (error) {
                    this.toast.showError('ÐžÑˆÐ¸Ð±ÐºÐ°', error.message);
                    this.telegram.haptic('light');
                    throw error;
                }
            }
            
            finishGame(result) {
                const completedGame = {
                    ...this.game.toJSON(),
                    completedAt: Date.now(),
                    duration: Date.now() - this.game.createdAt,
                    loser: result.loser?.id || null,
                    totalRounds: this.game.rounds.length
                };
                
                this.storage.saveCompletedGame(completedGame);
                this.storage.clearCurrentGame();
                this.telegram.haptic('light');
                this.router.navigate('finish', { game: completedGame, result });
            }
            
            forceEndGame() {
                this.telegram.showConfirm('Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ Ð±ÐµÐ· ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°?', (confirmed) => {
                    if (confirmed) {
                        this.storage.clearCurrentGame();
                        this.telegram.haptic('light');
                        this.router.navigate('setup');
                    }
                });
            }
            
            saveGame() {
                if (this.game.status === 'in_progress') {
                    this.storage.saveCurrentGame(this.game.toJSON());
                }
            }
        }

        // ===== SCREENS =====
        class Screen {
            constructor(app) {
                this.app = app;
                this.element = document.createElement('div');
                this.element.className = 'screen';
            }
            
            render(data) {
                // Override in subclass
            }
        }

        class WelcomeScreen extends Screen {
            render(data) {
                // Hide BackButton on welcome screen (root screen)
                this.app.telegram.hideBackButton();
                
                const hasSavedGame = data.hasSavedGame || false;
                const completedGames = this.app.storage.getCompletedGames();
                
                this.element.innerHTML = `
                    <div class="welcome">
                        <svg class="welcome-logo" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                            <path fill="#1A1A1A" d="M499.048,174.608l-104.262-46.414c-3.052-2.604-6.848-4.415-11.091-4.993l-0.172-0.043l-7.632-3.381c-5.821-2.56-12.126-2.439-17.497-0.121l-80.858-11.391c-4.422-3.138-9.95-4.665-15.721-3.838l-5.82,0.828l-5.778-0.828c-5.771-0.828-11.306,0.699-15.714,3.838l-80.866,11.391c-5.407-2.318-11.72-2.482-17.497,0.121l-7.632,3.381l-0.164,0.043c-4.294,0.621-8.124,2.389-11.184,5.036L12.984,174.608C1.97,179.516-3.022,192.433,1.892,203.489l85.196,191.354c4.95,11.013,17.825,15.964,28.881,11.056l83.012-36.97l57.056-8.003l57.021,8.003l83.012,36.97c11.013,4.908,23.924-0.043,28.832-11.056l85.202-191.397C515.012,192.433,510.062,179.516,499.048,174.608z M285.911,120.269l62.091,8.709c-0.37,0.621-0.699,1.234-0.991,1.898l-35.85,80.537c-2.561-5.778-4.501-11.02-5.158-14.529c-0.128-0.657-0.292-0.992-0.584-1.027c-0.329-0.043-0.536,0.249-0.82,0.82c-1.242,2.475-3.588,5.778-6.434,9.408c-2.768,3.431-5.984,7.14-9.323,10.728c-7.346,7.925-15.228,15.307-19.187,17.661l-0.371,0.449l0.25,0.585c4.001,4.287,11.919,18.146,17.412,30.236l-25.13,56.486c-4.172,9.365-1.198,20.086,6.563,26.114c1.362,1.07,2.888,1.983,4.536,2.725l4.536,2.018l-21.413-3.01l-12.375-1.733l-18.817-2.639l-8.374-1.198c-6.105-0.863-10.314-6.477-9.486-12.54l6.926-49.388l11.056-78.469l11.185-79.588c0.328-2.397,1.405-4.501,2.974-6.106c2.389-2.518,5.899-3.88,9.566-3.381l7.304,1.028l16.919,2.354L285.911,120.269z M111.596,396.12c-5.613,2.475-12.176-0.042-14.694-5.649L11.708,199.117c-2.475-5.614,0.042-12.212,5.656-14.687l92.207-41.093c-0.121,1.484-0.036,3.01,0.164,4.537l11.597,82.435c-5.114-2.311-9.572-4.544-12.254-6.898c-0.413-0.371-0.621-0.449-0.742-0.371c-0.128,0.086-0.249,0.25-0.249,0.828c-0.079,8.502-7.425,24.423-10.522,37.462c-2.846,12.012,0.043,25.621,11.841,29.131c7.019,2.104,15.307-1.362,19.309-7.547l10.15,72.406c1.57,11.056,11.178,19.016,22.112,18.81L111.596,396.12z M196.086,358.495l-34.031,4.786c-6.07,0.863-11.676-3.388-12.546-9.451l-7.097-50.579l-2.839-20.015l-0.706-4.986l-6.027-42.912l-12.496-88.954c-0.457-3.424,0.663-6.719,2.846-9.073c1.655-1.854,3.959-3.138,6.641-3.509l1.733-0.242l19.972-2.811l12.462-1.733l62.091-8.745c-0.249,0.913-0.456,1.82-0.584,2.768l-10.393,74.054c-2.639-0.784-5.486-1.07-8.417-0.663c-10.607,1.491-17.989,11.348-16.498,21.912c0.614,4.372,2.639,8.21,5.564,11.099c-1.07-0.042-2.104,0-3.174,0.164c-10.564,1.483-17.989,11.305-16.505,21.912c1.491,10.6,11.348,17.989,21.905,16.499c2.768-0.371,5.328-1.363,7.554-2.761l-9.159,65.188c-1.363,9.573,3.716,18.567,11.926,22.611c2.061,1.07,4.286,1.769,6.683,2.104l2.475,0.329L196.086,358.495z M500.325,199.117l-85.202,191.354c-2.511,5.607-9.116,8.124-14.722,5.649l-49.388-21.99l-35.109-15.635l-12.212-5.443l-16.548-7.346l-9.858-4.415c-5.613-2.518-8.132-9.08-5.649-14.686l20.706-46.542l4.087-9.159l8.253-18.524l12.618-28.425l39.53-88.747c0.82-1.855,2.104-3.381,3.674-4.458c3.088-2.268,7.261-2.846,11.013-1.148l8.866,3.959l8.417,3.709l13.66,6.106l92.214,41.057C500.283,186.905,502.8,193.503,500.325,199.117z"/>
                            <path fill="#1A1A1A" d="M395.45,241.529c1.934-12.09-9.244-23.596-22.447-20.179c-12.625,3.26-18.482,18.403-14.608,34.331c3.552,14.686,12.055,31.149,12.34,40.059l0.328,0.578l0.663-0.164c6.804-5.734,24.716-10.435,38.04-17.618c14.402-7.796,21.742-22.233,15.721-33.831C419.174,232.613,403.161,231.999,395.45,241.529z"/>
                            <path fill="#1A1A1A" d="M367.396,182.775l0.121,0.293l0.286-0.086c3.096-2.596,11.22-4.701,17.247-7.961c6.52-3.552,9.865-10.072,7.14-15.349c-2.889-5.443-10.15-5.735-13.617-1.406c0.87-5.485-4.209-10.728-10.186-9.158c-5.742,1.491-8.382,8.338-6.605,15.557C363.395,171.305,367.226,178.774,367.396,182.775z"/>
                            <path fill="#1A1A1A" d="M399.117,354.536c0.87-5.493-4.202-10.685-10.186-9.159c-5.692,1.484-8.332,8.331-6.598,15.55c1.605,6.684,5.443,14.109,5.606,18.153l0.121,0.25l0.293-0.086c3.096-2.553,11.22-4.701,17.247-7.96c6.555-3.509,9.858-10.064,7.14-15.307C409.887,350.491,402.626,350.199,399.117,354.536z"/>
                            <path fill="#1A1A1A" d="M51.238,201.064c-4.458-2.433-10.778-4.401-13.189-6.534l-0.286-0.135l-0.099,0.313c-0.022,3.21-2.79,9.223-3.966,14.166c-1.084,4.529,0.014,9.672,4.48,10.999c2.982,0.898,6.577-0.884,7.782-3.788c1.248,3.31,2.176,6.619,2.39,9.644l5.613-2.504c-2.104-2.182-3.944-5.079-5.571-8.224c2.968,1.041,6.691-0.428,8.024-3.246C58.414,207.548,55.332,203.289,51.238,201.064z"/>
                            <path fill="#1A1A1A" d="M158.488,158.673c-0.45,0.064-0.892,0.164-1.32,0.293c0.87-1.534,1.256-3.36,0.984-5.243c-0.642-4.551-4.858-7.746-9.416-7.104c-4.565,0.641-7.753,4.878-7.119,9.43c0.264,1.883,1.141,3.531,2.397,4.764c-0.442-0.007-0.892,0.021-1.348,0.085c-4.558,0.642-7.746,4.865-7.104,9.423c0.642,4.565,4.872,7.746,9.43,7.111c2.546-0.364,4.665-1.847,5.927-3.873c0.25,3.674,0.172,7.218-0.485,10.329l6.926-0.978c-1.484-2.803-2.54-6.192-3.317-9.793c1.776,1.605,4.222,2.446,6.769,2.09c4.558-0.642,7.746-4.872,7.111-9.437C167.283,161.22,163.054,158.031,158.488,158.673z"/>
                            <path fill="#1A1A1A" d="M263.299,132.303l-0.35,0.356c-2.154,4.315-11.741,14.309-15.036,16.27l-0.171,0.207l0.107,0.242c2.632,2.804,9.08,15.05,9.972,19.78l0.242,0.449l0.356-0.364c2.162-4.308,11.741-14.302,15.036-16.27l0.171-0.2l-0.114-0.243c-2.618-2.796-9.073-15.043-9.965-19.787L263.299,132.303z"/>
                        </svg>
                        <h1 class="welcome-title">101</h1>
                        <p class="welcome-subtitle">ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð³Ñ€Ð°</p>
                        <div class="welcome-buttons">
                            ${hasSavedGame ? '<button class="btn btn-primary btn-lg welcome-button" id="btn-continue">ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ</button>' : ''}
                            <button class="btn ${hasSavedGame ? 'btn-secondary' : 'btn-primary'} btn-lg welcome-button" id="btn-new-game">ÐÐ¾Ð²Ð°Ñ Ð¸Ð³Ñ€Ð°</button>
                            ${completedGames.length > 0 ? '<button class="btn btn-secondary btn-lg welcome-button" id="btn-history">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð³Ñ€</button>' : ''}
                        </div>
                    </div>
                `;
                
                // Event listeners
                if (hasSavedGame) {
                    this.element.querySelector('#btn-continue')?.addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.app.continueGame();
                    });
                }
                
                this.element.querySelector('#btn-new-game').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    if (hasSavedGame) {
                        this.app.telegram.showConfirm('ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ? Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¸Ð³Ñ€Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð°.', (confirmed) => {
                            if (confirmed) {
                                this.app.storage.clearCurrentGame();
                                this.app.router.navigate('setup');
                            }
                        });
                    } else {
                        this.app.router.navigate('setup');
                    }
                });
                
                this.element.querySelector('#btn-history')?.addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('history');
                });
            }
        }

        class SetupScreen extends Screen {
            constructor(app) {
                super(app);
                this.players = ['', ''];
            }
            
            render(data) {
                const savedPlayers = this.app.storage.getPlayers();
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">ÐÐ¾Ð²Ð°Ñ Ð¸Ð³Ñ€Ð°</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        ${savedPlayers.length > 0 ? `
                            <div style="text-align: right; margin-bottom: var(--space-3);">
                                <button class="btn btn-secondary" id="btn-manage-players" style="font-size: var(--font-size-sm);">
                                    <span style="margin-right: var(--space-2);">âš™ï¸</span>
                                    Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼Ð¸
                                </button>
                            </div>
                        ` : ''}
                        <h3 class="mb-4">Ð˜Ð³Ñ€Ð¾ÐºÐ¸</h3>
                        <div class="player-list" id="player-list"></div>
                        <div class="add-player-container">
                            <button class="btn btn-secondary btn-icon" id="btn-add-player" style="font-size: 32px; font-weight: 300;">+</button>
                        </div>
                        <button class="btn btn-primary btn-lg" style="width: 100%;" id="btn-start">ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ</button>
                    </div>
                    
                    <!-- Datalist for autocomplete -->
                    <datalist id="players-datalist">
                        ${savedPlayers.map(p => `<option value="${p}">`).join('')}
                    </datalist>
                `;
                
                this.renderPlayers();
                
                // Show Telegram BackButton
                this.app.telegram.showBackButton(() => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('welcome');
                });
                
                this.element.querySelector('#btn-add-player').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    if (this.players.length < 8) {
                        this.players.push('');
                        this.renderPlayers();
                    }
                });
                
                this.element.querySelector('#btn-start').addEventListener('click', () => {
                    this.startGame();
                });
                
                // Manage players button
                const manageBtn = this.element.querySelector('#btn-manage-players');
                if (manageBtn) {
                    manageBtn.addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.showManagePlayersModal();
                    });
                }
            }
            
            renderPlayers() {
                const container = this.element.querySelector('#player-list');
                container.innerHTML = '';
                
                this.players.forEach((name, index) => {
                    const color = CHART_COLORS[index % CHART_COLORS.length];
                    const item = document.createElement('div');
                    item.className = 'player-item';
                    item.innerHTML = `
                        <div class="player-color" style="background-color: ${color};"></div>
                        <input type="text" class="input" list="players-datalist" placeholder="Ð˜Ð¼Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ° ${index + 1}" value="${name}" data-index="${index}" autocomplete="off">
                        <button class="btn-remove" data-index="${index}" style="visibility: ${this.players.length > 2 ? 'visible' : 'hidden'};">Ã—</button>
                    `;
                    container.appendChild(item);
                });
                
                container.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.players[index] = e.target.value;
                        this.updateDatalist();
                    });
                });
                
                container.querySelectorAll('.btn-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.app.telegram.haptic('light');
                        const index = parseInt(e.currentTarget.dataset.index);
                        this.players.splice(index, 1);
                        this.renderPlayers();
                    });
                });
                
                this.updateDatalist();
            }
            
            updateDatalist() {
                const datalist = this.element.querySelector('#players-datalist');
                if (!datalist) return;
                
                const savedPlayers = this.app.storage.getPlayers();
                const selectedNames = this.players.map(p => p.trim()).filter(p => p !== '');
                
                const availablePlayers = savedPlayers.filter(p => !selectedNames.includes(p));
                
                datalist.innerHTML = availablePlayers.map(p => `<option value="${p}">`).join('');
            }
            
            startGame() {
                const playerNames = this.players.map(p => p.trim()).filter(p => p !== '');
                
                if (playerNames.length < 2) {
                    this.app.toast.showError('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²', 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 2 Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²');
                    this.app.telegram.haptic('light');
                    return;
                }
                
                const uniqueNames = new Set(playerNames);
                if (uniqueNames.size !== playerNames.length) {
                    this.app.toast.showError('Ð”ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð¼Ñ‘Ð½', 'Ð˜Ð¼ÐµÐ½Ð° Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸');
                    this.app.telegram.haptic('light');
                    return;
                }
                
                // Save player names to storage
                playerNames.forEach(name => {
                    this.app.storage.addPlayer(name);
                });
                
                this.app.startNewGame(playerNames);
            }
            
            showManagePlayersModal() {
                const savedPlayers = this.app.storage.getPlayers();
                
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal-backdrop active" id="manage-backdrop">
                        <div class="modal active" id="manage-modal">
                            <div class="modal-header">
                                <h3 class="modal-title">Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼Ð¸</h3>
                                <button class="modal-close" id="modal-close">Ã—</button>
                            </div>
                            <div class="modal-content">
                                <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                                    Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²: ${savedPlayers.length}
                                </p>
                                <div id="saved-players-list" style="max-height: 300px; overflow-y: auto; margin-bottom: var(--space-4);">
                                    ${savedPlayers.length > 0 ? savedPlayers.map((player, index) => `
                                        <div class="player-item" style="margin-bottom: var(--space-2);">
                                            <div class="player-color" style="background-color: ${CHART_COLORS[index % CHART_COLORS.length]};"></div>
                                            <span style="flex: 1; padding: var(--space-2);">${player}</span>
                                            <button class="btn-remove" data-player-name="${player}">Ã—</button>
                                        </div>
                                    `).join('') : '<p class="text-center text-secondary">Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿ÑƒÑÑ‚</p>'}
                                </div>
                            </div>
                            <div class="modal-actions">
                                ${savedPlayers.length > 0 ? '<button class="btn btn-danger" id="btn-clear-all">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑ‘</button>' : ''}
                                <button class="btn btn-secondary" id="btn-close">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const backdrop = modal.querySelector('#manage-backdrop');
                const modalEl = modal.querySelector('#manage-modal');
                
                const closeModal = () => {
                    modalEl.classList.remove('active');
                    backdrop.classList.remove('active');
                    setTimeout(() => {
                        modal.remove();
                        // Re-render to update datalist
                        this.render({});
                    }, 300);
                };
                
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeModal();
                });
                
                modal.querySelector('#modal-close').addEventListener('click', closeModal);
                modal.querySelector('#btn-close').addEventListener('click', closeModal);
                
                // Remove individual player
                modal.querySelectorAll('.btn-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.app.telegram.haptic('light');
                        const playerName = e.currentTarget.dataset.playerName;
                        this.app.storage.removePlayer(playerName);
                        closeModal();
                    });
                });
                
                // Clear all players
                const clearAllBtn = modal.querySelector('#btn-clear-all');
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.app.telegram.showConfirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµÑ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°?', (confirmed) => {
                            if (confirmed) {
                                this.app.storage.clearAllPlayers();
                                this.app.telegram.haptic('light');
                                closeModal();
                            }
                        });
                    });
                }
            }
        }

        class GameScreen extends Screen {
            render(data) {
                // Hide BackButton on game screen (main game state)
                this.app.telegram.hideBackButton();
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">Ð˜Ð³Ñ€Ð° 101</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        <div class="game-layout">
                            <div class="scoreboard">
                                <h3 class="scoreboard-title">Ð¡Ñ‡ÐµÑ‚ (Ð Ð°ÑƒÐ½Ð´ ${this.app.game.rounds.length})</h3>
                                <div id="scores"></div>
                            </div>
                            <div class="round-inputs">
                                <h3 class="round-title">ÐžÑ‡ÐºÐ¸ Ð·Ð° Ñ€Ð°ÑƒÐ½Ð´</h3>
                                <div id="round-inputs"></div>
                                <button class="btn btn-primary mt-4" style="width: 100%;" id="btn-submit">Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ</button>
                            </div>
                            <div class="chart-container">
                                <canvas id="game-chart"></canvas>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: var(--space-6); padding-bottom: var(--space-6);">
                            <button class="btn btn-secondary" id="btn-rules" style="margin-right: var(--space-3);">ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°</button>
                            <button class="btn btn-danger" id="btn-end-game">Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ</button>
                        </div>
                    </div>
                `;
                
                this.renderScores();
                this.renderRoundInputs();
                this.renderChart();
                
                // Event listeners
                this.element.querySelector('#btn-rules').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    // Use confirm for rules (needs user acknowledgment)
                    this.app.telegram.showAlert('ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð¸Ð³Ñ€Ñ‹ 101:\n\n1. ÐŸÑ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ 50 Ð¾Ñ‡ÐºÐ¾Ð² â†’ ÑÐ±Ñ€Ð¾Ñ Ð´Ð¾ 25\n2. ÐŸÑ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ñ€Ð¾Ð²Ð½Ð¾ 101 Ð¾Ñ‡ÐºÐ° â†’ ÑÐ±Ñ€Ð¾Ñ Ð´Ð¾ 0\n3. ÐŸÑ€Ð¸ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¸Ð¸ 101 â†’ ÐŸÐ ÐžÐ˜Ð“Ð Ð«Ð¨\n4. Ð˜Ð³Ñ€Ð° Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÐºÐ° ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°ÐµÑ‚\n5. Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ñ‡ÐºÐ¸');
                });
                
                this.element.querySelector('#btn-end-game').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.forceEndGame();
                });
                
                this.element.querySelector('#btn-submit').addEventListener('click', () => {
                    this.submitRound();
                });
                
                // Enter key support for round inputs
                this.element.querySelectorAll('#round-inputs input').forEach((input, index, inputs) => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            // Move to next input or submit
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            } else {
                                this.submitRound();
                            }
                        }
                    });
                });
                
                // Auto-focus first input
                const firstInput = this.element.querySelector('#round-inputs input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 300);
                }
            }
            
            renderScores(animate = false) {
                const container = this.element.querySelector('#scores');
                container.innerHTML = '';
                
                // Sort by score
                const sortedPlayers = [...this.app.game.players].sort((a, b) => b.score - a.score);
                const leader = sortedPlayers[0];
                
                sortedPlayers.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'score-item';
                    if (animate) {
                        item.classList.add('score-updated');
                        item.style.animationDelay = `${index * 50}ms`;
                    }
                    if (player.id === leader.id && player.score > 0) {
                        item.classList.add('leader');
                    }
                    item.innerHTML = `
                        <div class="score-player">
                            <div class="score-player-color" style="background-color: ${player.color};"></div>
                            <span class="score-player-name">${player.name}</span>
                        </div>
                        <span class="score-value">${player.score}</span>
                    `;
                    container.appendChild(item);
                });
            }
            
            renderRoundInputs() {
                const container = this.element.querySelector('#round-inputs');
                container.innerHTML = '';
                
                this.app.game.players.forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'round-item';
                    item.innerHTML = `
                        <label class="round-label">${player.name}:</label>
                        <input type="number" class="input" placeholder="0" data-player-id="${player.id}" inputmode="numeric">
                    `;
                    container.appendChild(item);
                });
            }
            
            renderChart() {
                const canvas = this.element.querySelector('#game-chart');
                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (this.app.chart) {
                    this.app.chart.destroy();
                }
                
                const datasets = this.app.game.players.map(player => ({
                    label: player.name,
                    data: player.scoreHistory,
                    borderColor: player.color,
                    backgroundColor: player.color,
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }));
                
                const labels = Array.from({ length: this.app.game.rounds.length + 1 }, (_, i) => i);
                
                // Calculate Y axis range - always start with 0-101
                const allScores = this.app.game.players.flatMap(p => p.scoreHistory);
                const min = Math.min(...allScores);
                const max = Math.max(...allScores);
                
                // Default range: 0 to 101
                let yMin = 0;
                let yMax = 101;
                
                // Expand if values go below 0
                if (min < 0) {
                    yMin = Math.floor(min / 10) * 10;
                }
                
                // Expand if values go above 101
                if (max > 101) {
                    yMax = Math.ceil(max / 10) * 10;
                }
                
                this.app.chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                min: yMin,
                                max: yMax,
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: 'Ð¡Ñ‡ÐµÑ‚',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            },
                            x: {
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: 'Ð Ð°ÑƒÐ½Ð´',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#1A1A1A',
                                    padding: 20,
                                    font: { size: 13, weight: '500' },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: '#FFFFFF',
                                titleColor: '#1A1A1A',
                                bodyColor: '#6B7280',
                                borderColor: '#E5E7EB',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    title: (items) => `Ð Ð°ÑƒÐ½Ð´ ${items[0].label}`,
                                    label: (item) => `${item.dataset.label}: ${item.parsed.y}`
                                }
                            }
                        }
                    }
                });
            }
            
            submitRound() {
                const inputs = this.element.querySelectorAll('#round-inputs input');
                const points = {};
                let allFilled = true;
                
                inputs.forEach(input => {
                    const playerId = input.dataset.playerId;
                    const value = input.value.trim();
                    
                    if (value === '') {
                        allFilled = false;
                        return;
                    }
                    
                    const numValue = parseInt(value, 10);
                    if (isNaN(numValue)) {
                        allFilled = false;
                        return;
                    }
                    
                    points[playerId] = numValue;
                });
                
                if (!allFilled) {
                    this.app.toast.showError('Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ', 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¾Ñ‡ÐºÐ¸ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²');
                    this.app.telegram.haptic('light');
                    return;
                }
                
                try {
                    const result = this.app.submitRound(points);
                    
                    // Clear inputs
                    inputs.forEach(input => input.value = '');
                    
                    // Re-render with animation
                    this.renderScores(true);
                    this.renderChart();
                    
                    // Update round number
                    this.element.querySelector('.scoreboard-title').textContent = `Ð¡Ñ‡ÐµÑ‚ (Ð Ð°ÑƒÐ½Ð´ ${this.app.game.rounds.length})`;
                    
                    // Auto-focus first input for next round (only if game continues)
                    if (!result.gameOver) {
                        setTimeout(() => {
                            const firstInput = this.element.querySelector('#round-inputs input');
                            if (firstInput) firstInput.focus();
                        }, 100);
                        this.app.telegram.haptic('light');
                    }
                } catch (error) {
                    // Error already handled in app
                }
            }
        }

        class FinishScreen extends Screen {
            render(data) {
                // Hide BackButton on finish screen (final state)
                this.app.telegram.hideBackButton();
                
                const { game, result } = data;
                const loser = result.loser;
                
                let message = `<p class="text-error" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">ðŸ˜” ${loser.name} Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ð»</p>`;
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">Ð˜Ð³Ñ€Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        <div class="text-center mb-6">
                            ${message}
                            <p class="text-secondary">Ð Ð°ÑƒÐ½Ð´Ð¾Ð² ÑÑ‹Ð³Ñ€Ð°Ð½Ð¾: ${game.totalRounds}</p>
                            <p class="text-secondary">Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: ${Utils.formatDuration(game.duration)}</p>
                        </div>
                        
                        <div class="scoreboard mb-6">
                            <h3 class="scoreboard-title">Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑÑ‡ÐµÑ‚</h3>
                            <div id="final-scores"></div>
                        </div>
                        
                        <div class="chart-container mb-6">
                            <canvas id="finish-chart"></canvas>
                        </div>
                        
                        <div style="display: flex; gap: var(--space-3);">
                            <button class="btn btn-secondary" style="flex: 1;" id="btn-history">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ</button>
                            <button class="btn btn-primary" style="flex: 1;" id="btn-new-game">ÐÐ¾Ð²Ð°Ñ Ð¸Ð³Ñ€Ð°</button>
                        </div>
                    </div>
                `;
                
                this.renderFinalScores(game, loser);
                this.renderChart(game);
                
                this.element.querySelector('#btn-history').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('history');
                });
                
                this.element.querySelector('#btn-new-game').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('setup');
                });
            }
            
            renderFinalScores(game, loser) {
                const container = this.element.querySelector('#final-scores');
                const sortedPlayers = [...game.players].sort((a, b) => b.score - a.score);
                
                sortedPlayers.forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'score-item';
                    
                    const isLoser = loser && player.id === loser.id;
                    
                    item.innerHTML = `
                        <div class="score-player">
                            <div class="score-player-color" style="background-color: ${player.color};"></div>
                            <span class="score-player-name">${player.name}</span>
                            ${isLoser ? '<span style="margin-left: 8px;">ðŸ˜”</span>' : ''}
                        </div>
                        <span class="score-value">${player.score}</span>
                    `;
                    container.appendChild(item);
                });
            }
            
            renderChart(game) {
                const canvas = this.element.querySelector('#finish-chart');
                const ctx = canvas.getContext('2d');
                
                const datasets = game.players.map(player => ({
                    label: player.name,
                    data: player.scoreHistory,
                    borderColor: player.color,
                    backgroundColor: player.color,
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }));
                
                const labels = Array.from({ length: game.rounds.length + 1 }, (_, i) => i);
                
                // Calculate Y axis range - always start with 0-101
                const allScores = game.players.flatMap(p => p.scoreHistory);
                const min = Math.min(...allScores);
                const max = Math.max(...allScores);
                
                // Default range: 0 to 101
                let yMin = 0;
                let yMax = 101;
                
                // Expand if values go below 0
                if (min < 0) {
                    yMin = Math.floor(min / 10) * 10;
                }
                
                // Expand if values go above 101
                if (max > 101) {
                    yMax = Math.ceil(max / 10) * 10;
                }
                
                new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                min: yMin,
                                max: yMax,
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: 'Ð¡Ñ‡ÐµÑ‚',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            },
                            x: {
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: 'Ð Ð°ÑƒÐ½Ð´',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#1A1A1A',
                                    padding: 20,
                                    font: { size: 13, weight: '500' },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: '#FFFFFF',
                                titleColor: '#1A1A1A',
                                bodyColor: '#6B7280',
                                borderColor: '#E5E7EB',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    title: (items) => `Ð Ð°ÑƒÐ½Ð´ ${items[0].label}`,
                                    label: (item) => `${item.dataset.label}: ${item.parsed.y}`
                                }
                            }
                        }
                    }
                });
            }
        }

        class HistoryScreen extends Screen {
            render(data) {
                const games = this.app.storage.getCompletedGames();
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð³Ñ€</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        ${games.length > 0 ? `
                            <div style="text-align: right; margin-bottom: var(--space-4);">
                                <button class="btn btn-secondary" id="btn-clear">
                                    <span style="margin-right: var(--space-2);">ðŸ—‘ï¸</span>
                                    ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
                                </button>
                            </div>
                            <div class="history-list" id="history-list"></div>
                        ` : this.renderEmptyState()}
                    </div>
                `;
                
                if (games.length > 0) {
                    this.renderGames(games);
                    
                    this.element.querySelector('#btn-clear').addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.clearHistory();
                    });
                }
                
                // Show Telegram BackButton
                this.app.telegram.showBackButton(() => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('welcome');
                });
            }
            
            renderGames(games) {
                const container = this.element.querySelector('#history-list');
                
                games.forEach(game => {
                    const loser = game.players.find(p => p.id === game.loser);
                    
                    const card = document.createElement('div');
                    card.className = 'card history-card';
                    card.innerHTML = `
                        <div class="history-header">
                            <div>
                                <div class="card-title">${Utils.formatDate(game.completedAt)}</div>
                                <div class="history-date">${Utils.formatDuration(game.duration)} â€¢ ${game.totalRounds} Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð²</div>
                            </div>
                        </div>
                        <div class="history-players">
                            ${game.players.map(p => {
                                const isLoser = loser && p.id === loser.id;
                                return `<span class="history-player ${isLoser ? 'history-loser' : ''}">${p.name} (${p.score})</span>`;
                            }).join('')}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            renderEmptyState() {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“Š</div>
                        <h3 class="empty-title">ÐÐµÑ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ñ… Ð¸Ð³Ñ€</h3>
                        <p class="empty-text">Ð¡Ñ‹Ð³Ñ€Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¸Ð³Ñ€Ñƒ, Ð¸ Ð·Ð´ÐµÑÑŒ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ</p>
                    </div>
                `;
            }
            
            clearHistory() {
                this.app.telegram.showConfirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð³Ñ€?', (confirmed) => {
                    if (confirmed) {
                        this.app.storage.clearAllGames();
                        this.app.telegram.haptic('light');
                        this.render({});
                    }
                });
            }
        }

        // ===== INIT APP =====
        window.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
</body>
</html>
