<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F8F9FA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–≥—Ä—ã –≤ –∫–∞—Ä—Ç–æ—á–Ω—É—é –∏–≥—Ä—É 101">
    <meta name="author" content="Denis">
    <title>–ò–≥—Ä–∞ 101</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéÆ</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ===== DESIGN SYSTEM 2026 ===== */
        :root {
            /* Base colors - Light theme */
            --color-bg-primary: #F8F9FA;
            --color-bg-secondary: #FFFFFF;
            --color-bg-tertiary: #F1F3F5;
            --color-bg-elevated: #FFFFFF;
            
            /* Text colors */
            --color-text-primary: #1A1A1A;
            --color-text-secondary: #6B7280;
            --color-text-tertiary: #9CA3AF;
            --color-text-disabled: #D1D5DB;
            
            /* Accent colors - Vibrant and modern */
            --color-accent-primary: #3B82F6;
            --color-accent-success: #10B981;
            --color-accent-warning: #F59E0B;
            --color-accent-error: #EF4444;
            --color-accent-purple: #8B5CF6;
            
            /* Chart colors - Bright and distinguishable */
            --color-chart-1: #3B82F6;
            --color-chart-2: #10B981;
            --color-chart-3: #F59E0B;
            --color-chart-4: #EF4444;
            --color-chart-5: #8B5CF6;
            --color-chart-6: #EC4899;
            --color-chart-7: #14B8A6;
            --color-chart-8: #F97316;
            
            /* Borders */
            --color-border-subtle: #E5E7EB;
            --color-border-default: #D1D5DB;
            --color-border-strong: #9CA3AF;
            
            /* Shadows - Softer for light theme */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.12);
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index */
            --z-base: 0;
            --z-dropdown: 1000;
            --z-sticky: 1100;
            --z-fixed: 1200;
            --z-modal-backdrop: 1300;
            --z-modal: 1400;
            --z-popover: 1500;
            --z-tooltip: 1600;
        }
        
        /* ===== RESET & BASE ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-size-adjust: 100%;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            line-height: 1.5;
            color: var(--color-text-primary);
            background-color: var(--color-bg-primary);
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }
        
        /* Platform-specific full-screen adjustments */
        body.platform-mobile {
            /* Mobile: use safe area insets for notches/bars and add extra padding for camera */
            padding-top: max(env(safe-area-inset-top, 0px), 20px);
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        body.platform-desktop {
            /* Desktop: no extra padding needed */
            padding: 0;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-bold);
            line-height: 1.2;
            color: var(--color-text-primary);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-2xl); }
        h3 { font-size: var(--font-size-xl); }
        
        /* ===== LAYOUT ===== */
        .app {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* Fullscreen optimization */
        body.platform-mobile .app,
        body.platform-desktop .app {
            width: 100%;
            max-width: 100%;
        }
        
        /* For smaller screens, maintain max-width */
        @media (min-width: 800px) {
            body.platform-desktop .app {
                max-width: 800px;
            }
        }
        
        .screen {
            display: none;
            opacity: 0;
            animation: fadeIn var(--transition-base) forwards;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-subtle);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .header-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }
        
        .btn-back {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            border: none;
            color: var(--color-text-primary);
            font-size: var(--font-size-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-back:hover {
            background: var(--color-bg-elevated);
            transform: scale(1.05);
        }
        
        .btn-back:active {
            transform: scale(0.95);
        }
        
        /* ===== CONTENT ===== */
        .content {
            padding: var(--space-6);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-xl);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .btn-primary {
            background: var(--color-accent-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-success {
            background: var(--color-accent-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--color-accent-error);
            color: white;
        }
        
        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-default);
        }
        
        .btn-secondary:hover {
            background: var(--color-bg-tertiary);
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: var(--radius-full);
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== INPUTS ===== */
        .input-group {
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: block;
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            transition: all var(--transition-fast);
            min-height: 44px;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            background: var(--color-bg-tertiary);
        }
        
        .input::placeholder {
            color: var(--color-text-tertiary);
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-border-default);
            transform: translateY(-2px);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }
        
        .card-content {
            color: var(--color-text-secondary);
        }
        
        /* ===== WELCOME SCREEN ===== */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--space-6);
            text-align: center;
        }
        
        .welcome-title {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-2);
            color: var(--color-text-primary);
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .welcome-subtitle {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
            font-size: var(--font-size-lg);
        }
        
        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            width: 100%;
            max-width: 320px;
        }
        
        .welcome-button {
            width: 100%;
        }
        
        /* ===== PLAYER SETUP ===== */
        .player-list {
            margin-bottom: var(--space-6);
        }
        
        .player-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .player-item .input {
            flex: 1;
        }
        
        .player-color {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 2px solid var(--color-border-default);
            flex-shrink: 0;
        }
        
        .btn-remove {
            background: transparent;
            border: none;
            color: var(--color-accent-error);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            padding: var(--space-2);
            line-height: 1;
            transition: all var(--transition-fast);
        }
        
        .btn-remove:hover {
            transform: scale(1.2);
        }
        
        .add-player-container {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-6);
        }
        
        /* ===== GAME SCREEN ===== */
        .game-layout {
            display: grid;
            gap: var(--space-6);
        }
        
        .scoreboard {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .scoreboard-title {
            margin-bottom: var(--space-4);
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-lg);
            border-left: 4px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .score-item.leader {
            border-left-color: var(--color-accent-success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .score-player {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .score-player-color {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }
        
        .score-player-name {
            font-weight: var(--font-weight-medium);
        }
        
        .score-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
        }
        
        /* ===== ROUND INPUT ===== */
        .round-inputs {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .round-title {
            margin-bottom: var(--space-4);
        }
        
        .round-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .round-label {
            min-width: 100px;
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }
        
        .round-item .input {
            max-width: 120px;
        }
        
        /* ===== CHART ===== */
        .chart-container {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            height: 400px;
            position: relative;
            border: 1px solid var(--color-border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        @media (max-width: 640px) {
            .chart-container {
                height: 300px;
            }
        }
        
        /* ===== HISTORY ===== */
        .history-list {
            display: grid;
            gap: var(--space-4);
        }
        
        .history-card {
            cursor: pointer;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }
        
        .history-date {
            font-size: var(--font-size-sm);
            color: var(--color-text-tertiary);
        }
        
        .history-players {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .history-player {
            padding: var(--space-1) var(--space-3);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }
        
        .history-loser {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-accent-error);
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-2);
        }
        
        .empty-text {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-6);
        }
        
        /* ===== MODAL ===== */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: var(--z-modal-backdrop);
            backdrop-filter: blur(4px);
        }
        
        .modal-backdrop.active {
            display: block;
            animation: fadeIn var(--transition-fast);
        }
        
        .modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            padding: var(--space-6);
            z-index: var(--z-modal);
            transform: translateY(100%);
            transition: transform var(--transition-base);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal.active {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            padding: var(--space-2);
            line-height: 1;
        }
        
        .modal-content {
            margin-bottom: var(--space-6);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-3);
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0) + var(--space-4));
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-tooltip);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: center;
            width: auto;
            max-width: calc(100% - var(--space-8));
        }
        
        .toast {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            box-shadow: var(--shadow-lg);
            pointer-events: auto;
            animation: slideDown 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-width: 280px;
            max-width: 400px;
        }
        
        .toast.toast-success {
            border-left: 4px solid var(--color-accent-success);
        }
        
        .toast.toast-warning {
            border-left: 4px solid var(--color-accent-warning);
        }
        
        .toast.toast-error {
            border-left: 4px solid var(--color-accent-error);
        }
        
        .toast.toast-info {
            border-left: 4px solid var(--color-accent-primary);
        }
        
        .toast-icon {
            font-size: var(--font-size-xl);
            line-height: 1;
        }
        
        .toast-message {
            flex: 1;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .toast.removing {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        /* ===== UTILITIES ===== */
        .text-center { text-align: center; }
        .text-success { color: var(--color-accent-success); }
        .text-error { color: var(--color-accent-error); }
        .text-warning { color: var(--color-accent-warning); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .hidden { display: none !important; }
        
        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes scoreUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: var(--color-bg-elevated); }
            100% { transform: scale(1); }
        }
        
        .score-updated {
            animation: scoreUpdate 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        /* ===== SCROLLBAR ===== */
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--color-bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--color-bg-elevated);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-border-strong);
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--color-bg-elevated) var(--color-bg-primary);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-container {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app"></div>

    <script>
        'use strict';

        // ===== CONSTANTS =====
        const STORAGE_VERSION = '1.0';
        const STORAGE_KEY = 'game101_data';
        const CHART_COLORS = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
            '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
        ];

        // ===== UTILITIES =====
        const Utils = {
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            formatDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                // Less than 1 hour ago
                if (diffMins < 60) {
                    if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                    return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                }
                
                // Less than 24 hours ago
                if (diffMins < 1440) {
                    const hours = Math.floor(diffMins / 60);
                    return `${hours} —á –Ω–∞–∑–∞–¥`;
                }
                
                // More than 24 hours - show full date
                return new Intl.DateTimeFormat('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            },
            
            formatDuration(ms) {
                const minutes = Math.floor(ms / 60000);
                if (minutes < 60) return `${minutes} –º–∏–Ω`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours} —á ${mins} –º–∏–Ω`;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ===== STORAGE MANAGER =====
        class StorageManager {
            constructor() {
                this.init();
            }
            
            init() {
                try {
                    const data = this.load();
                    if (!data || data.version !== STORAGE_VERSION) {
                        this.initializeStorage();
                    }
                } catch (error) {
                    console.error('Storage init error:', error);
                    this.initializeStorage();
                }
            }
            
            initializeStorage() {
                const defaultData = {
                    version: STORAGE_VERSION,
                    currentGame: null,
                    completedGames: [],
                    settings: {
                        hapticEnabled: true,
                        soundEnabled: false
                    }
                };
                this.save(defaultData);
            }
            
            load() {
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Storage load error:', error);
                    return null;
                }
            }
            
            save(data) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage save error:', error);
                    return false;
                }
            }
            
            getCurrentGame() {
                const data = this.load();
                return data?.currentGame;
            }
            
            saveCurrentGame(game) {
                const data = this.load();
                if (data) {
                    data.currentGame = game;
                    return this.save(data);
                }
                return false;
            }
            
            clearCurrentGame() {
                const data = this.load();
                if (data) {
                    data.currentGame = null;
                    return this.save(data);
                }
                return false;
            }
            
            getCompletedGames() {
                const data = this.load();
                return data?.completedGames || [];
            }
            
            saveCompletedGame(game) {
                const data = this.load();
                if (data) {
                    data.completedGames.unshift(game);
                    return this.save(data);
                }
                return false;
            }
            
            clearAllGames() {
                const data = this.load();
                if (data) {
                    data.completedGames = [];
                    data.currentGame = null;
                    return this.save(data);
                }
                return false;
            }
        }

        // ===== GAME ENGINE =====
        class GameEngine {
            constructor() {
                this.id = null;
                this.createdAt = null;
                this.updatedAt = null;
                this.players = [];
                this.rounds = [];
                this.status = 'setup';
            }
            
            createGame(playerNames) {
                if (playerNames.length < 2) {
                    throw new Error('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞');
                }
                
                // Check for duplicates
                const uniqueNames = new Set(playerNames);
                if (uniqueNames.size !== playerNames.length) {
                    throw new Error('–ò–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏');
                }
                
                this.id = Utils.generateId();
                this.createdAt = Date.now();
                this.updatedAt = Date.now();
                this.status = 'in_progress';
                
                this.players = playerNames.map((name, index) => ({
                    id: Utils.generateId(),
                    name: name.trim(),
                    color: CHART_COLORS[index % CHART_COLORS.length],
                    score: 0,
                    scoreHistory: [0]
                }));
                
                return this;
            }
            
            submitRound(points) {
                if (this.status !== 'in_progress') {
                    throw new Error('–ò–≥—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞');
                }
                
                // Validate points
                for (const player of this.players) {
                    if (!(player.id in points)) {
                        throw new Error(`–ù–µ —É–∫–∞–∑–∞–Ω—ã –æ—á–∫–∏ –¥–ª—è ${player.name}`);
                    }
                    if (typeof points[player.id] !== 'number' || isNaN(points[player.id])) {
                        throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—á–∫–∏ –¥–ª—è ${player.name}`);
                    }
                }
                
                const round = {
                    roundNumber: this.rounds.length + 1,
                    timestamp: Date.now(),
                    points: { ...points }
                };
                
                // Calculate new scores
                const results = [];
                
                for (const player of this.players) {
                    const pointsEarned = points[player.id];
                    let newScore = player.score + pointsEarned;
                    
                    // Apply game rules
                    if (newScore === 50) {
                        newScore = 25; // Cutoff at 50
                    } else if (newScore === 101) {
                        // Reset to 0 when reaching exactly 101
                        newScore = 0;
                    } else if (newScore > 101) {
                        // Loser - exceeded 101
                        results.push({ playerId: player.id, status: 'loser', score: newScore });
                    }
                    
                    player.score = newScore;
                    player.scoreHistory.push(newScore);
                }
                
                this.rounds.push(round);
                this.updatedAt = Date.now();
                
                // Check for game end (only when someone loses)
                const loser = results.find(r => r.status === 'loser');
                
                if (loser) {
                    this.status = 'finished';
                    return {
                        gameOver: true,
                        loser: this.players.find(p => p.id === loser.playerId)
                    };
                }
                
                return { gameOver: false };
            }
            
            toJSON() {
                return {
                    id: this.id,
                    createdAt: this.createdAt,
                    updatedAt: this.updatedAt,
                    players: this.players,
                    rounds: this.rounds,
                    status: this.status
                };
            }
            
            fromJSON(data) {
                Object.assign(this, data);
                return this;
            }
        }

        // ===== TELEGRAM API =====
        class TelegramAPI {
            constructor() {
                this.app = window.Telegram?.WebApp;
                this.backButtonCallback = null;
                this.init();
            }
            
            init() {
                if (!this.app) return;
                
                try {
                    // Basic initialization
                    this.app.ready();
                    this.app.expand();
                    this.app.disableVerticalSwipes();
                    this.app.setHeaderColor('#F8F9FA');
                    this.app.setBackgroundColor('#F8F9FA');
                    this.app.enableClosingConfirmation();
                    
                    // Hide BackButton initially
                    this.app.BackButton.hide();
                    
                    // Add platform class to body
                    const isMobile = ['android', 'ios'].includes(this.app.platform);
                    document.body.classList.add(isMobile ? 'platform-mobile' : 'platform-desktop');
                    
                    // Request fullscreen on mobile (requires Telegram WebApp API 8.0+)
                    if (['android', 'ios'].includes(this.app.platform) && this.app.isVersionAtLeast('8.0')) {
                        setTimeout(() => {
                            this.app.requestFullscreen()
                                .then(() => {
                                    console.log('Fullscreen mode enabled');
                                })
                                .catch((error) => {
                                    console.log('Fullscreen not available, using expand:', error);
                                    this.app.expand();
                                });
                        }, 300);
                    }
                    
                    // Request fullscreen on desktop too (for browsers that support it)
                    if (!['android', 'ios'].includes(this.app.platform) && this.app.isVersionAtLeast('8.0')) {
                        setTimeout(() => {
                            this.app.requestFullscreen()
                                .catch(() => {
                                    console.log('Fullscreen not available on desktop');
                                });
                        }, 300);
                    }
                } catch (error) {
                    console.error('Telegram API init error:', error);
                }
            }
            
            // BackButton management
            showBackButton(callback) {
                if (!this.app?.BackButton) return;
                
                // Remove old callback if exists
                if (this.backButtonCallback) {
                    this.app.BackButton.offClick(this.backButtonCallback);
                }
                
                // Set new callback
                this.backButtonCallback = callback;
                this.app.BackButton.onClick(this.backButtonCallback);
                this.app.BackButton.show();
            }
            
            hideBackButton() {
                if (!this.app?.BackButton) return;
                
                // Remove callback
                if (this.backButtonCallback) {
                    this.app.BackButton.offClick(this.backButtonCallback);
                    this.backButtonCallback = null;
                }
                
                this.app.BackButton.hide();
            }
            
            haptic(type = 'light') {
                if (!this.app?.HapticFeedback) return;
                try {
                    if (type === 'success' || type === 'error' || type === 'warning') {
                        this.app.HapticFeedback.notificationOccurred(type);
                    } else {
                        this.app.HapticFeedback.impactOccurred(type);
                    }
                } catch (error) {
                    console.error('Haptic error:', error);
                }
            }
            
            showAlert(message) {
                if (this.app?.showAlert) {
                    this.app.showAlert(message);
                } else {
                    alert(message);
                }
            }
            
            showConfirm(message, callback) {
                if (this.app?.showConfirm) {
                    this.app.showConfirm(message, callback);
                } else {
                    const result = confirm(message);
                    callback(result);
                }
            }
        }

        // ===== ROUTER =====
        class Router {
            constructor(app) {
                this.app = app;
                this.currentScreen = null;
                this.isNavigating = false;
            }
            
            navigate(screenName, data = {}) {
                if (this.isNavigating) return;
                this.isNavigating = true;
                
                const oldScreen = this.currentScreen;
                const newScreen = this.app.screens[screenName];
                
                if (!newScreen) {
                    this.isNavigating = false;
                    return;
                }
                
                // Fade out old screen
                if (oldScreen) {
                    oldScreen.element.style.animation = 'fadeOut var(--transition-base) forwards';
                    setTimeout(() => {
                        oldScreen.element.style.display = 'none';
                        oldScreen.element.classList.remove('active');
                        oldScreen.element.style.animation = '';
                        
                        // Show new screen
                        this.showNewScreen(newScreen, data);
                    }, 200);
                } else {
                    // No old screen, show new screen immediately
                    this.showNewScreen(newScreen, data);
                }
                
                window.scrollTo(0, 0);
            }
            
            showNewScreen(screen, data) {
                this.currentScreen = screen;
                screen.render(data);
                screen.element.style.display = 'block';
                screen.element.style.opacity = '0';
                
                // Force reflow
                screen.element.offsetHeight;
                
                setTimeout(() => {
                    screen.element.classList.add('active');
                    screen.element.style.opacity = '1';
                    this.isNavigating = false;
                }, 50);
            }
        }

        // ===== TOAST MANAGER =====
        class ToastManager {
            constructor() {
                this.container = null;
                this.init();
            }
            
            init() {
                this.container = document.createElement('div');
                this.container.className = 'toast-container';
                document.body.appendChild(this.container);
            }
            
            show(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    success: '‚úì',
                    warning: '‚ö†Ô∏è',
                    error: '‚úï',
                    info: '‚ÑπÔ∏è'
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                `;
                
                this.container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        // ===== APP =====
        class App {
            constructor() {
                this.storage = new StorageManager();
                this.telegram = new TelegramAPI();
                this.game = new GameEngine();
                this.router = new Router(this);
                this.toast = new ToastManager();
                this.chart = null;
                this.screens = {};
                
                this.init();
            }
            
            init() {
                this.initScreens();
                this.checkForSavedGame();
            }
            
            initScreens() {
                // Create all screens
                this.screens.welcome = new WelcomeScreen(this);
                this.screens.setup = new SetupScreen(this);
                this.screens.game = new GameScreen(this);
                this.screens.finish = new FinishScreen(this);
                this.screens.history = new HistoryScreen(this);
                
                // Render to app container
                const appElement = document.getElementById('app');
                Object.values(this.screens).forEach(screen => {
                    appElement.appendChild(screen.element);
                });
            }
            
            checkForSavedGame() {
                const savedGame = this.storage.getCurrentGame();
                if (savedGame) {
                    // Has saved game
                    this.router.navigate('welcome', { hasSavedGame: true });
                } else {
                    // No saved game
                    this.router.navigate('welcome', { hasSavedGame: false });
                }
            }
            
            startNewGame(playerNames) {
                try {
                    this.game = new GameEngine();
                    this.game.createGame(playerNames);
                    this.saveGame();
                    this.telegram.haptic('success');
                    this.router.navigate('game');
                } catch (error) {
                    this.telegram.showAlert(error.message);
                    this.telegram.haptic('error');
                }
            }
            
            continueGame() {
                const savedGame = this.storage.getCurrentGame();
                if (savedGame) {
                    this.game = new GameEngine().fromJSON(savedGame);
                    this.router.navigate('game');
                }
            }
            
            submitRound(points) {
                try {
                    const result = this.game.submitRound(points);
                    this.saveGame();
                    this.telegram.haptic('light');
                    
                    if (result.gameOver) {
                        this.finishGame(result);
                    }
                    
                    return result;
                } catch (error) {
                    this.telegram.showAlert(error.message);
                    this.telegram.haptic('error');
                    throw error;
                }
            }
            
            finishGame(result) {
                const completedGame = {
                    ...this.game.toJSON(),
                    completedAt: Date.now(),
                    duration: Date.now() - this.game.createdAt,
                    loser: result.loser?.id || null,
                    totalRounds: this.game.rounds.length
                };
                
                this.storage.saveCompletedGame(completedGame);
                this.storage.clearCurrentGame();
                this.telegram.haptic('error'); // Error haptic for game end
                this.router.navigate('finish', { game: completedGame, result });
            }
            
            forceEndGame() {
                this.telegram.showConfirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞?', (confirmed) => {
                    if (confirmed) {
                        this.storage.clearCurrentGame();
                        this.telegram.haptic('success');
                        this.router.navigate('setup');
                    }
                });
            }
            
            saveGame() {
                if (this.game.status === 'in_progress') {
                    this.storage.saveCurrentGame(this.game.toJSON());
                }
            }
        }

        // ===== SCREENS =====
        class Screen {
            constructor(app) {
                this.app = app;
                this.element = document.createElement('div');
                this.element.className = 'screen';
            }
            
            render(data) {
                // Override in subclass
            }
        }

        class WelcomeScreen extends Screen {
            render(data) {
                // Hide BackButton on welcome screen (root screen)
                this.app.telegram.hideBackButton();
                
                const hasSavedGame = data.hasSavedGame || false;
                const completedGames = this.app.storage.getCompletedGames();
                
                this.element.innerHTML = `
                    <div class="welcome">
                        <h1 class="welcome-title">101</h1>
                        <p class="welcome-subtitle">–ö–∞—Ä—Ç–æ—á–Ω–∞—è –∏–≥—Ä–∞</p>
                        <div class="welcome-buttons">
                            ${hasSavedGame ? '<button class="btn btn-primary btn-lg welcome-button" id="btn-continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É</button>' : ''}
                            <button class="btn ${hasSavedGame ? 'btn-secondary' : 'btn-primary'} btn-lg welcome-button" id="btn-new-game">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                            ${completedGames.length > 0 ? '<button class="btn btn-secondary btn-lg welcome-button" id="btn-history">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</button>' : ''}
                        </div>
                    </div>
                `;
                
                // Event listeners
                if (hasSavedGame) {
                    this.element.querySelector('#btn-continue')?.addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.app.continueGame();
                    });
                }
                
                this.element.querySelector('#btn-new-game').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    if (hasSavedGame) {
                        this.app.telegram.showConfirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–∞.', (confirmed) => {
                            if (confirmed) {
                                this.app.storage.clearCurrentGame();
                                this.app.router.navigate('setup');
                            }
                        });
                    } else {
                        this.app.router.navigate('setup');
                    }
                });
                
                this.element.querySelector('#btn-history')?.addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('history');
                });
            }
        }

        class SetupScreen extends Screen {
            constructor(app) {
                super(app);
                this.players = ['', ''];
            }
            
            render(data) {
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">–ù–æ–≤–∞—è –∏–≥—Ä–∞</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        <h3 class="mb-4">–ò–≥—Ä–æ–∫–∏</h3>
                        <div class="player-list" id="player-list"></div>
                        <div class="add-player-container">
                            <button class="btn btn-secondary btn-icon" id="btn-add-player">+</button>
                        </div>
                        <button class="btn btn-primary btn-lg" style="width: 100%;" id="btn-start">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                    </div>
                `;
                
                this.renderPlayers();
                
                // Show Telegram BackButton
                this.app.telegram.showBackButton(() => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('welcome');
                });
                
                this.element.querySelector('#btn-add-player').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    if (this.players.length < 8) {
                        this.players.push('');
                        this.renderPlayers();
                    }
                });
                
                this.element.querySelector('#btn-start').addEventListener('click', () => {
                    this.startGame();
                });
            }
            
            renderPlayers() {
                const container = this.element.querySelector('#player-list');
                container.innerHTML = '';
                
                this.players.forEach((name, index) => {
                    const color = CHART_COLORS[index % CHART_COLORS.length];
                    const item = document.createElement('div');
                    item.className = 'player-item';
                    item.innerHTML = `
                        <div class="player-color" style="background-color: ${color};"></div>
                        <input type="text" class="input" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞ ${index + 1}" value="${name}" data-index="${index}">
                        ${this.players.length > 2 ? '<button class="btn-remove" data-index="' + index + '">√ó</button>' : '<div style="width: 32px;"></div>'}
                    `;
                    container.appendChild(item);
                });
                
                // Input listeners
                container.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.players[index] = e.target.value;
                    });
                });
                
                // Remove listeners
                container.querySelectorAll('.btn-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.app.telegram.haptic('light');
                        const index = parseInt(e.currentTarget.dataset.index);
                        this.players.splice(index, 1);
                        this.renderPlayers();
                    });
                });
            }
            
            startGame() {
                const playerNames = this.players.map(p => p.trim()).filter(p => p !== '');
                
                if (playerNames.length < 2) {
                    this.app.telegram.showAlert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–æ–≤');
                    this.app.telegram.haptic('error');
                    return;
                }
                
                // Check for duplicates
                const uniqueNames = new Set(playerNames);
                if (uniqueNames.size !== playerNames.length) {
                    this.app.telegram.showAlert('–ò–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏');
                    this.app.telegram.haptic('error');
                    return;
                }
                
                this.app.startNewGame(playerNames);
            }
        }

        class GameScreen extends Screen {
            render(data) {
                // Hide BackButton on game screen (we use menu instead)
                this.app.telegram.hideBackButton();
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">–ò–≥—Ä–∞ 101</h2>
                        <button class="btn-back" id="btn-menu">‚ãÆ</button>
                    </div>
                    <div class="content">
                        <div class="game-layout">
                            <div class="scoreboard">
                                <h3 class="scoreboard-title">–°—á–µ—Ç (–†–∞—É–Ω–¥ ${this.app.game.rounds.length})</h3>
                                <div id="scores"></div>
                            </div>
                            <div class="round-inputs">
                                <h3 class="round-title">–û—á–∫–∏ –∑–∞ —Ä–∞—É–Ω–¥</h3>
                                <div id="round-inputs"></div>
                                <button class="btn btn-primary mt-4" style="width: 100%;" id="btn-submit">–ó–∞–ø–∏—Å–∞—Ç—å</button>
                            </div>
                            <div class="chart-container">
                                <canvas id="game-chart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                this.renderScores();
                this.renderRoundInputs();
                this.renderChart();
                
                // Event listeners
                this.element.querySelector('#btn-menu').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.showMenu();
                });
                
                this.element.querySelector('#btn-submit').addEventListener('click', () => {
                    this.submitRound();
                });
                
                // Enter key support for round inputs
                this.element.querySelectorAll('#round-inputs input').forEach((input, index, inputs) => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            // Move to next input or submit
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            } else {
                                this.submitRound();
                            }
                        }
                    });
                });
                
                // Auto-focus first input
                const firstInput = this.element.querySelector('#round-inputs input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 300);
                }
            }
            
            renderScores(animate = false) {
                const container = this.element.querySelector('#scores');
                container.innerHTML = '';
                
                // Sort by score
                const sortedPlayers = [...this.app.game.players].sort((a, b) => b.score - a.score);
                const leader = sortedPlayers[0];
                
                sortedPlayers.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'score-item';
                    if (animate) {
                        item.classList.add('score-updated');
                        item.style.animationDelay = `${index * 50}ms`;
                    }
                    if (player.id === leader.id && player.score > 0) {
                        item.classList.add('leader');
                    }
                    item.innerHTML = `
                        <div class="score-player">
                            <div class="score-player-color" style="background-color: ${player.color};"></div>
                            <span class="score-player-name">${player.name}</span>
                        </div>
                        <span class="score-value">${player.score}</span>
                    `;
                    container.appendChild(item);
                });
            }
            
            renderRoundInputs() {
                const container = this.element.querySelector('#round-inputs');
                container.innerHTML = '';
                
                this.app.game.players.forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'round-item';
                    item.innerHTML = `
                        <label class="round-label">${player.name}:</label>
                        <input type="number" class="input" placeholder="0" data-player-id="${player.id}" inputmode="numeric">
                    `;
                    container.appendChild(item);
                });
            }
            
            renderChart() {
                const canvas = this.element.querySelector('#game-chart');
                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (this.app.chart) {
                    this.app.chart.destroy();
                }
                
                const datasets = this.app.game.players.map(player => ({
                    label: player.name,
                    data: player.scoreHistory,
                    borderColor: player.color,
                    backgroundColor: player.color,
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }));
                
                const labels = Array.from({ length: this.app.game.rounds.length + 1 }, (_, i) => i);
                
                // Calculate Y axis range
                const allScores = this.app.game.players.flatMap(p => p.scoreHistory);
                const min = Math.min(...allScores, 0);
                const max = Math.max(...allScores, 101);
                const yMin = Math.floor(min / 20) * 20 - 10;
                const yMax = Math.ceil(max / 20) * 20 + 10;
                
                this.app.chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                min: yMin,
                                max: yMax,
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: '–°—á–µ—Ç',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            },
                            x: {
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: '–†–∞—É–Ω–¥',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#1A1A1A',
                                    padding: 15,
                                    font: { size: 13, weight: '500' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: '#FFFFFF',
                                titleColor: '#1A1A1A',
                                bodyColor: '#6B7280',
                                borderColor: '#E5E7EB',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    title: (items) => `–†–∞—É–Ω–¥ ${items[0].label}`,
                                    label: (item) => `${item.dataset.label}: ${item.parsed.y}`
                                }
                            }
                        }
                    }
                });
            }
            
            submitRound() {
                const inputs = this.element.querySelectorAll('#round-inputs input');
                const points = {};
                let allFilled = true;
                
                inputs.forEach(input => {
                    const playerId = input.dataset.playerId;
                    const value = input.value.trim();
                    
                    if (value === '') {
                        allFilled = false;
                        return;
                    }
                    
                    const numValue = parseInt(value, 10);
                    if (isNaN(numValue)) {
                        allFilled = false;
                        return;
                    }
                    
                    points[playerId] = numValue;
                });
                
                if (!allFilled) {
                    this.app.telegram.showAlert('–í–≤–µ–¥–∏—Ç–µ –æ—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤');
                    this.app.telegram.haptic('error');
                    return;
                }
                
                try {
                    const result = this.app.submitRound(points);
                    
                    // Clear inputs
                    inputs.forEach(input => input.value = '');
                    
                    // Re-render with animation
                    this.renderScores(true);
                    this.renderChart();
                    
                    // Update round number
                    this.element.querySelector('.scoreboard-title').textContent = `–°—á–µ—Ç (–†–∞—É–Ω–¥ ${this.app.game.rounds.length})`;
                    
                    // Auto-focus first input for next round (only if game continues)
                    if (!result.gameOver) {
                        setTimeout(() => {
                            const firstInput = this.element.querySelector('#round-inputs input');
                            if (firstInput) firstInput.focus();
                        }, 100);
                        this.app.telegram.haptic('light');
                    }
                } catch (error) {
                    // Error already handled in app
                }
            }
            
            showMenu() {
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal-backdrop active" id="menu-backdrop">
                        <div class="modal active" id="menu-modal">
                            <div class="modal-header">
                                <h3 class="modal-title">–ú–µ–Ω—é</h3>
                                <button class="modal-close" id="modal-close">√ó</button>
                            </div>
                            <div class="modal-content">
                                <button class="btn btn-secondary mb-4" style="width: 100%;" id="btn-rules">–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</button>
                                <button class="btn btn-danger" style="width: 100%;" id="btn-end-game">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const backdrop = modal.querySelector('#menu-backdrop');
                const modalEl = modal.querySelector('#menu-modal');
                
                const closeModal = () => {
                    modalEl.classList.remove('active');
                    backdrop.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
                
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeModal();
                });
                
                modal.querySelector('#modal-close').addEventListener('click', closeModal);
                
                modal.querySelector('#btn-rules').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.telegram.showAlert('–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã 101:\n\n1. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 50 –æ—á–∫–æ–≤ ‚Üí —Å–±—Ä–æ—Å –¥–æ 25\n2. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ä–æ–≤–Ω–æ 101 –æ—á–∫–∞ ‚Üí —Å–±—Ä–æ—Å –¥–æ 0\n3. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 101 ‚Üí –ü–†–û–ò–ì–†–´–®\n4. –ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ –ø—Ä–æ–∏–≥—Ä–∞–µ—Ç\n5. –î–æ–ø—É—Å—Ç–∏–º—ã –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –æ—á–∫–∏');
                });
                
                modal.querySelector('#btn-end-game').addEventListener('click', () => {
                    closeModal();
                    this.app.forceEndGame();
                });
            }
        }

        class FinishScreen extends Screen {
            render(data) {
                // Hide BackButton on finish screen (final state)
                this.app.telegram.hideBackButton();
                
                const { game, result } = data;
                const loser = result.loser;
                
                let message = `<p class="text-error" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">üòî ${loser.name} –ø—Ä–æ–∏–≥—Ä–∞–ª</p>`;
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
                        <div style="width: 40px;"></div>
                    </div>
                    <div class="content">
                        <div class="text-center mb-6">
                            ${message}
                            <p class="text-secondary">–†–∞—É–Ω–¥–æ–≤ —Å—ã–≥—Ä–∞–Ω–æ: ${game.totalRounds}</p>
                            <p class="text-secondary">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${Utils.formatDuration(game.duration)}</p>
                        </div>
                        
                        <div class="scoreboard mb-6">
                            <h3 class="scoreboard-title">–ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç</h3>
                            <div id="final-scores"></div>
                        </div>
                        
                        <div class="chart-container mb-6">
                            <canvas id="finish-chart"></canvas>
                        </div>
                        
                        <div style="display: flex; gap: var(--space-3);">
                            <button class="btn btn-secondary" style="flex: 1;" id="btn-history">–ò—Å—Ç–æ—Ä–∏—è</button>
                            <button class="btn btn-primary" style="flex: 1;" id="btn-new-game">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                        </div>
                    </div>
                `;
                
                this.renderFinalScores(game, loser);
                this.renderChart(game);
                
                this.element.querySelector('#btn-history').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('history');
                });
                
                this.element.querySelector('#btn-new-game').addEventListener('click', () => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('setup');
                });
            }
            
            renderFinalScores(game, loser) {
                const container = this.element.querySelector('#final-scores');
                const sortedPlayers = [...game.players].sort((a, b) => b.score - a.score);
                
                sortedPlayers.forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'score-item';
                    
                    const isLoser = loser && player.id === loser.id;
                    
                    item.innerHTML = `
                        <div class="score-player">
                            <div class="score-player-color" style="background-color: ${player.color};"></div>
                            <span class="score-player-name">${player.name}</span>
                            ${isLoser ? '<span style="margin-left: 8px;">üòî</span>' : ''}
                        </div>
                        <span class="score-value">${player.score}</span>
                    `;
                    container.appendChild(item);
                });
            }
            
            renderChart(game) {
                const canvas = this.element.querySelector('#finish-chart');
                const ctx = canvas.getContext('2d');
                
                const datasets = game.players.map(player => ({
                    label: player.name,
                    data: player.scoreHistory,
                    borderColor: player.color,
                    backgroundColor: player.color,
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }));
                
                const labels = Array.from({ length: game.rounds.length + 1 }, (_, i) => i);
                
                const allScores = game.players.flatMap(p => p.scoreHistory);
                const min = Math.min(...allScores, 0);
                const max = Math.max(...allScores, 101);
                const yMin = Math.floor(min / 20) * 20 - 10;
                const yMax = Math.ceil(max / 20) * 20 + 10;
                
                new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                min: yMin,
                                max: yMax,
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: '–°—á–µ—Ç',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            },
                            x: {
                                grid: { color: '#E5E7EB' },
                                ticks: {
                                    color: '#6B7280',
                                    font: { size: 12, weight: '500' }
                                },
                                title: {
                                    display: true,
                                    text: '–†–∞—É–Ω–¥',
                                    color: '#1A1A1A',
                                    font: { size: 14, weight: '600' }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#1A1A1A',
                                    padding: 15,
                                    font: { size: 13, weight: '500' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: '#FFFFFF',
                                titleColor: '#1A1A1A',
                                bodyColor: '#6B7280',
                                borderColor: '#E5E7EB',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    title: (items) => `–†–∞—É–Ω–¥ ${items[0].label}`,
                                    label: (item) => `${item.dataset.label}: ${item.parsed.y}`
                                }
                            }
                        }
                    }
                });
            }
        }

        class HistoryScreen extends Screen {
            render(data) {
                const games = this.app.storage.getCompletedGames();
                
                this.element.innerHTML = `
                    <div class="header">
                        <div style="width: 40px;"></div>
                        <h2 class="header-title">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2>
                        ${games.length > 0 ? '<button class="btn-back" id="btn-clear">üóëÔ∏è</button>' : '<div style="width: 40px;"></div>'}
                    </div>
                    <div class="content">
                        ${games.length > 0 ? '<div class="history-list" id="history-list"></div>' : this.renderEmptyState()}
                    </div>
                `;
                
                if (games.length > 0) {
                    this.renderGames(games);
                    
                    this.element.querySelector('#btn-clear').addEventListener('click', () => {
                        this.app.telegram.haptic('light');
                        this.clearHistory();
                    });
                }
                
                // Show Telegram BackButton
                this.app.telegram.showBackButton(() => {
                    this.app.telegram.haptic('light');
                    this.app.router.navigate('welcome');
                });
            }
            
            renderGames(games) {
                const container = this.element.querySelector('#history-list');
                
                games.forEach(game => {
                    const loser = game.players.find(p => p.id === game.loser);
                    
                    const card = document.createElement('div');
                    card.className = 'card history-card';
                    card.innerHTML = `
                        <div class="history-header">
                            <div>
                                <div class="card-title">${Utils.formatDate(game.completedAt)}</div>
                                <div class="history-date">${Utils.formatDuration(game.duration)} ‚Ä¢ ${game.totalRounds} —Ä–∞—É–Ω–¥–æ–≤</div>
                            </div>
                        </div>
                        <div class="history-players">
                            ${game.players.map(p => {
                                const isLoser = loser && p.id === loser.id;
                                return `<span class="history-player ${isLoser ? 'history-loser' : ''}">${p.name} (${p.score})</span>`;
                            }).join('')}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            renderEmptyState() {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <h3 class="empty-title">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∏–≥—Ä</h3>
                        <p class="empty-text">–°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É, –∏ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è</p>
                    </div>
                `;
            }
            
            clearHistory() {
                this.app.telegram.showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä?', (confirmed) => {
                    if (confirmed) {
                        this.app.storage.clearAllGames();
                        this.app.telegram.haptic('success');
                        this.render({});
                    }
                });
            }
        }

        // ===== INIT APP =====
        window.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
</body>
</html>
